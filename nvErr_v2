#!/usr/bin/env bash
set -euo pipefail

# --- Constants ---
readonly CONFIG_FILE="/hive/bin/nvErr.cfg"
readonly CURSOR_FILE="/var/tmp/nvErr.cursor"

TELEGRAM_ENABLED=0

# --- Load config ---
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
    # Enable Telegram notifications if token and chat ID are set
    [[ -n "${TELEGRAM_TOKEN:-}" && -n "${CHAT_ID:-}" ]] && TELEGRAM_ENABLED=1
fi

# --- Functions ---

# Send a message to Telegram
send_telegram() {
    [[ $TELEGRAM_ENABLED -eq 0 ]] && return
    curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
        -d chat_id="$CHAT_ID" \
        -d parse_mode="Markdown" \
        -d disable_web_page_preview=true \
        -d text="$1" >/dev/null
}

# Notify about GPU errors via Telegram and Hive message system
notify() {
    local errors="$1"
    if [[ $TELEGRAM_ENABLED -eq 1 ]]; then
        local telegram_msg=$'⚠️ *'"$(hostname)"$'*  *GPU Xid errors detected:*\n```\n'"$errors"$'\n```'
        send_telegram "$telegram_msg" &
    fi
    echo "$errors"
    # Send Hive message with unique ID
    local msg_id; msg_id=$(date +%s)
    echo "$errors" | /hive/bin/message danger "GPU Xid errors detected" payload -i="$msg_id" >/dev/null &
}

# Read journal logs for GPU Xid errors
read_journal() {
    local num_lines="${1:-0}"
    local errors=""

    if [[ "$num_lines" -gt 0 ]]; then
        # User requested last N lines
        errors=$(journalctl -n "$num_lines" -k --no-pager | grep -a "Xid" || true)
    else
        # Use array options for proper handling of spaces
        local journal_opts=(-k --no-pager)
        if [[ -f "$CURSOR_FILE" ]]; then
            journal_opts+=(--after-cursor="$(<"$CURSOR_FILE")")
        else
            journal_opts+=(--since="1 hour ago")
        fi

        errors=$(journalctl "${journal_opts[@]}" | grep -a "Xid" || true)

        # Save last cursor position for next run
        local last_cursor
        last_cursor=$(journalctl "${journal_opts[@]}" --show-cursor 2>/dev/null | sed -n 's/^-- cursor: //p' | tail -n1 || true)
        [[ -n "$last_cursor" ]] && echo "$last_cursor" > "$CURSOR_FILE"
    fi

    echo "$errors"
}

# Check for GPU errors and notify if any
check_errors() {
    local num_lines="${1:-0}"
    local errors
    errors=$(read_journal "$num_lines")
    [[ -n "$errors" ]] && notify "$errors"
}

# --- Main ---
check_errors "${1:-0}"
