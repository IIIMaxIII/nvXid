#!/usr/bin/env bash
set -euo pipefail

SYSLOG="/var/log/syslog"
CONFIG_FILE="/hive/bin/nvErr.cfg"
TELEGRAM_ENABLED=0
STATE_FILE="/var/tmp/nvErr.pos"
INITIAL_LINES=100  # number of lines to check on first run

# --- Load config if exists ---
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
    [[ -n "${TELEGRAM_TOKEN:-}" && -n "${CHAT_ID:-}" ]] && TELEGRAM_ENABLED=1
fi

# --- Functions ---

send_telegram() {
    [[ $TELEGRAM_ENABLED -eq 0 ]] && return
    local msg="$1"
    curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
        -d chat_id="$CHAT_ID" \
        -d parse_mode="Markdown" \
        -d disable_web_page_preview=true \
        -d text="$msg" >/dev/null
}

notify() {
    local errors="$1"

    # Send to Telegram (Markdown formatted)
    if [[ $TELEGRAM_ENABLED -eq 1 ]]; then
        local telegram_msg=$'⚠ ️ *GPU Xid errors detected:*\n```\n'"$errors"$'\n```'
        send_telegram "$telegram_msg"
    fi

    # Print errors to console (for external shell usage)
    echo "$errors"

    # Send errors to Hive message only if running locally
#    if [[ -t 1 ]]; then
        local msg_id
        msg_id=$(date +%s)
        echo "$errors" | /hive/bin/message danger "GPU Xid errors detected" payload -i="$msg_id" >/dev/null
#    fi
}

check_errors() {
    local num_lines="${1:-0}"
    local first_run=0
    local last_size=0
    local errors=""

    # If user specified number of lines, ignore STATE_FILE
    if [[ "$num_lines" -gt 0 ]]; then
        errors=$(tail -n "$num_lines" "$SYSLOG" | grep -a "Xid")
    else
        # Determine last processed position
        if [[ -f "$STATE_FILE" ]]; then
            last_size=$(cat "$STATE_FILE")
            first_run=0
        else
            first_run=1
        fi

        # Get current size of syslog
        local cur_size
        cur_size=$(stat -c%s "$SYSLOG")

        if [[ $first_run -eq 1 ]]; then
            errors=$(tail -n "$INITIAL_LINES" "$SYSLOG" | grep -a "Xid")
        else
            [[ $cur_size -lt $last_size ]] && last_size=0  # log rotation
            errors=$(tail -c +$((last_size+1)) "$SYSLOG" | grep -a "Xid")
        fi

        # Save current position for next run
        echo "$cur_size" > "$STATE_FILE"
    fi

    [[ -n "$errors" ]] && notify "$errors"
}

# --- Main ---
NUM_LINES="${1:-0}"  # default 0 = use STATE_FILE logic
check_errors "$NUM_LINES"
